<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout | Sahabi</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <!-- Extra styles for checkout layout if not in style.css yet -->
</head>

<body>

    <!-- Navigation -->
    <nav class="navbar">
        <a href="index.html" class="logo"><img src="assets/logo.PNG" alt="Sahabi" style="height: 50px;"></a>
        <ul class="nav-links">
            <li><a href="index.html">Home</a></li>
            <li><a href="shop-perfumes.html">Perfumes</a></li>
            <li><a href="shop-oils.html">Oils</a></li>
            <li><a href="#offers">Offers</a></li>
        </ul>
        <a href="shop-perfumes.html" class="btn-nav">
            <span>Back to Shop</span>
        </a>
    </nav>

    <!-- Page Header -->
    <header class="page-header" style="padding-bottom: 3rem;">
        <h1 class="fade-in">Secure <span class="gold-text">Checkout</span></h1>
    </header>

    <div class="checkout-container fade-in delay-1">

        <!-- Left: Form -->
        <div class="checkout-form-section">
            <h2 class="section-title">Shipping Details</h2>
            <form id="checkout-form" onsubmit="handleCheckout(event)">
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" required placeholder="John Doe">
                </div>
                <div class="form-group">
                    <label>Email Address <span style="font-size: 0.8em; color: #888;">(Optional)</span></label>
                    <input type="email" placeholder="john@example.com">
                </div>
                <div class="form-group">
                    <label>Phone Number</label>
                    <input type="tel" required placeholder="+1 234 567 8900">
                </div>
                <div class="form-group">
                    <label>Shipping Address</label>
                    <textarea rows="3" required placeholder="Street, City, Country"></textarea>
                </div>

                <h2 class="section-title" style="margin-top: 2rem;">Payment Method</h2>
                <div class="payment-methods">
                    <label class="payment-option">
                        <input type="radio" name="payment" value="60" checked onchange="updateShipping()">
                        <span class="radio-custom"></span>
                        Cash on Delivery ( 60 inside Dhaka)
                    </label>
                    <label class="payment-option">
                        <input type="radio" name="payment" value="120" onchange="updateShipping()">
                        <span class="radio-custom"></span>
                        Cash on Delivery ( 120 outside Dhaka)
                    </label>
                </div>

                <button type="submit" class="btn-place-order">Place Order</button>
            </form>
        </div>

        <!-- Right: Order Summary -->
        <div class="order-summary-section">
            <h2 class="section-title">Order Summary</h2>
            <div class="summary-items" id="summary-items">
                <!-- Items injected here -->
            </div>

            <div class="summary-totals">
                <div class="summary-row">
                    <span>Subtotal</span>
                    <span id="subtotal-price">৳0.00</span>
                </div>
                <div class="summary-row">
                    <span>Shipping</span>
                    <span id="shipping-price">৳0.00</span>
                </div>
                <div class="summary-row total">
                    <span>Total</span>
                    <span id="total-price">৳0.00</span>
                </div>
            </div>
        </div>

    </div>

    <!-- Footer -->
    <footer>
        <div class="footer-content">
            <div class="footer-logo"><img src="assets/footer-logo.PNG" alt="Sahabi" style="height: 100px;"></div>
            <p>&copy; 2026 Sahabi Perfumes. All rights reserved.</p>
        </div>
    </footer>

    <script>
        // Load Cart
        const cart = JSON.parse(localStorage.getItem('sahabi_cart')) || [];

        function initCheckout() {
            const container = document.getElementById('summary-items');
            const subtotalEl = document.getElementById('subtotal-price');
            const totalEl = document.getElementById('total-price');

            if (cart.length === 0) {
                container.innerHTML = '<p>Your cart is empty. <a href="shop-perfumes.html" style="color:var(--accent-gold)">Go Shop</a></p>';
                document.querySelector('.btn-place-order').disabled = true;
                document.querySelector('.btn-place-order').style.opacity = 0.5;
                document.querySelector('.btn-place-order').style.cursor = 'not-allowed';
                return;
            }

            let total = 0;

            container.innerHTML = cart.map(item => {
                const itemTotal = item.price * item.quantity;
                total += itemTotal;
                return `
                    <div class="summary-item">
                        <div class="summary-img">
                            <img src="${item.image}" alt="${item.name}">
                            <span class="summary-qty">${item.quantity}</span>
                        </div>
                        <div class="summary-info">
                            <h4>${item.name}</h4>
                            <p>${item.size}</p>
                        </div>
                        <div class="summary-price">৳${itemTotal.toFixed(2)}</div>
                    </div>
                `;
            }).join('');

            subtotalEl.textContent = `৳${total.toFixed(2)}`;

            // Set subtotal to be used by updateShipping
            subtotalEl.dataset.value = total;

            // Initialize shipping right away based on checked radio
            updateShipping();
        }

        function updateShipping() {
            if (cart.length === 0) return;

            const subtotalEl = document.getElementById('subtotal-price');
            const shippingEl = document.getElementById('shipping-price');
            const totalEl = document.getElementById('total-price');

            // Get selected shipping cost
            const selectedShippingRadio = document.querySelector('input[name="payment"]:checked');
            const shippingCost = selectedShippingRadio ? parseFloat(selectedShippingRadio.value) : 0;

            const subtotal = parseFloat(subtotalEl.dataset.value) || 0;
            const newTotal = subtotal + shippingCost;

            // Update UI
            shippingEl.textContent = `৳${shippingCost.toFixed(2)}`;
            totalEl.textContent = `৳${newTotal.toFixed(2)}`;
        }

        async function handleCheckout(e) {
            e.preventDefault();

            if (cart.length === 0) return;

            const btn = document.querySelector('.btn-place-order');
            const originalText = btn.textContent;
            btn.textContent = 'Processing...';
            btn.disabled = true;

            // Collect Data
            const formData = {
                name: document.querySelector('input[type="text"]').value,
                email: document.querySelector('input[type="email"]').value,
                phone: document.querySelector('input[type="tel"]').value,
                address: document.querySelector('textarea').value,
                payment_method: document.querySelector('input[name="payment"]:checked').parentElement.textContent.trim(),
                cart_items: cart.map(item => `${item.name} (${item.size}) x${item.quantity}`).join(', '),
                total_price: document.getElementById('total-price').textContent
            };

            // Google Script URL
            const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwhwkHf66ABL16wfh_XNWNBR4fiDU8hRJHudF5jqpvs6pFmH1jN225viwlh6N0EqwL7/exec';

            try {
                // Send Data
                // Note: 'no-cors' mode is required for Google Apps Script Web Apps when called from frontend
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                // Success
                localStorage.removeItem('sahabi_cart');
                window.location.href = 'thank-you.html';

            } catch (error) {
                console.error('Error submitting order:', error);
                alert('There was an issue placing your order. Please try again or contact us directly.');
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            initCheckout();

            // Animations
            setTimeout(() => {
                document.querySelectorAll('.fade-in').forEach(el => el.classList.add('visible'));
            }, 100);
        });
    </script>
</body>

</html>